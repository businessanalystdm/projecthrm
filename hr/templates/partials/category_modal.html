<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalLabel">Category Management</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm" method="POST">
                    {% csrf_token %}
                    <input type="hidden" id="category_id" name="category_id">
                    <div class="mb-3">
                        <label for="category_name" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="category_name" name="category_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="category_company_name" class="form-label">Company</label>
                        <select class="form-select" name="company_name" id="category_company_name" required>
                            <option value="" disabled selected class="text-muted">-- Select Company --</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}">{{ company.company_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="category_department" class="form-label">Department</label>
                        <select class="form-select" name="department" id="category_department" required>
                            <option value="" disabled selected class="text-muted">-- Select Department --</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="category_sub_department" class="form-label">Sub-Department</label>
                        <select class="form-select" name="sub_department" id="category_sub_department" required>
                            <option value="" disabled selected class="text-muted">-- Select Sub-Department --</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" name="status" id="status" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </form>
                <hr>
                <div id="categoryList">
                    {% include 'partials/category_list.html' %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    console.log('Category modal script loaded');

    function loadDepartments(companyId) {
        console.log('loadDepartments called with companyId:', companyId);
        const deptSelect = document.getElementById("category_department");
        const subDeptSelect = document.getElementById("category_sub_department");
        console.log('deptSelect element:', deptSelect);
        console.log('subDeptSelect element:', subDeptSelect);

        if (!deptSelect) {
            console.error('Department select element not found!');
            return;
        }

        deptSelect.innerHTML = '<option value="" disabled selected>-- Loading --</option>';
        if (subDeptSelect) {
            subDeptSelect.innerHTML = '<option value="" disabled selected>-- Select Sub-Department --</option>';
        }

        fetch(`/department/by-company/${companyId}/`)
            .then(response => {
                console.log('Fetch response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Fetch response data:', data);
                deptSelect.innerHTML = '<option value="" disabled selected>-- Select Department --</option>';
                if (data.success && Array.isArray(data.departments)) {
                    data.departments.forEach(dept => {
                        console.log('Adding department:', dept);
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = dept.department_name;
                        deptSelect.appendChild(option);
                    });
                    console.log('Final deptSelect HTML:', deptSelect.innerHTML);
                    // Refresh select2 if used
                    if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
                        $(deptSelect).trigger('change.select2');
                    }
                } else {
                    console.error('Invalid response format or no departments:', data);
                    deptSelect.innerHTML = '<option value="" disabled selected>-- No Departments Available --</option>';
                }
            })
            .catch(error => {
                console.error('Error loading departments:', error);
                deptSelect.innerHTML = '<option value="" disabled selected>-- Select Department --</option>';
            });
    }

    function loadSubDepartments(departmentId) {
        console.log('loadSubDepartments called with departmentId:', departmentId);
        const subDeptSelect = document.getElementById("category_sub_department");
        console.log('subDeptSelect element:', subDeptSelect);

        if (!subDeptSelect) {
            console.error('Sub-department select element not found!');
            return;
        }

        subDeptSelect.innerHTML = '<option value="" disabled selected>-- Loading --</option>';

        fetch(`/sub-department/by-department/${departmentId}/`)
            .then(response => {
                console.log('Sub-department fetch response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Sub-department fetch response data:', data);
                subDeptSelect.innerHTML = '<option value="" disabled selected>-- Select Sub-Department --</option>';
                if (data.success && Array.isArray(data.subdepartments)) {
                    data.subdepartments.forEach(subDept => {
                        console.log('Adding sub-department:', subDept);
                        const option = document.createElement('option');
                        option.value = subDept.id;
                        option.textContent = subDept.sub_department_name;
                        subDeptSelect.appendChild(option);
                    });
                    console.log('Final subDeptSelect HTML:', subDeptSelect.innerHTML);
                    // Refresh select2 if used
                    if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
                        $(subDeptSelect).trigger('change.select2');
                    }
                } else {
                    console.error('Invalid response format or no sub-departments:', data);
                    subDeptSelect.innerHTML = '<option value="" disabled selected>-- No Sub-Departments Available --</option>';
                }
            })
            .catch(error => {
                console.error('Error loading sub-departments:', error);
                subDeptSelect.innerHTML = '<option value="" disabled selected>-- Select Sub-Department --</option>';
            });
    }

    function getCSRFToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!token) {
            console.error('CSRF token not found!');
            return null;
        }
        return token.value;
    }

    function loadCategoryList() {
        console.log('Category: loadCategoryList called');
        fetch("{% url 'category_list' %}", {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
            .then(response => {
                console.log('Category list fetch response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                requestAnimationFrame(() => {
                    document.getElementById("categoryList").innerHTML = html;
                });
            })
            .catch(error => {
                console.error('Category: Error loading categories:', error);
                alert('Failed to load categories.');
            });
    }

    // Make loadCategoryList globally accessible
    window.loadCategoryList = loadCategoryList;

    document.addEventListener("DOMContentLoaded", function () {
        console.log('Category modal DOMContentLoaded');
        const companySelect = document.getElementById("category_company_name");
        const departmentSelect = document.getElementById("category_department");
        const subDepartmentSelect = document.getElementById("category_sub_department");
        const categoryModal = document.getElementById("categoryModal");

        console.log('companySelect:', companySelect);
        console.log('departmentSelect:', departmentSelect);
        console.log('subDepartmentSelect:', subDepartmentSelect);
        console.log('categoryModal:', categoryModal);

        if (!companySelect || !departmentSelect || !subDepartmentSelect || !categoryModal) {
            console.error('One or more elements not found:', {
                companySelect, departmentSelect, subDepartmentSelect, categoryModal
            });
            return;
        }

        // Bind click event for load-category-list links
        document.querySelectorAll('.load-category-list').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                loadCategoryList();
            });
        });

        categoryModal.addEventListener("change", function (event) {
            if (event.target.id === "category_company_name") {
                const companyId = event.target.value;
                console.log('Category: Selected company ID:', companyId);
                if (companyId) {
                    loadDepartments(companyId);
                } else {
                    departmentSelect.innerHTML = '<option value="" disabled selected>-- Select Department --</option>';
                    subDepartmentSelect.innerHTML = '<option value="" disabled selected>-- Select Sub-Department --</option>';
                }
            }
        });

        departmentSelect.addEventListener("change", function () {
            const departmentId = this.value;
            console.log('Category: Selected department ID:', departmentId);
            if (departmentId) {
                loadSubDepartments(departmentId);
            } else {
                subDepartmentSelect.innerHTML = '<option value="" disabled selected>-- Select Sub-Department --</option>';
            }
        });

        categoryModal.addEventListener("show.bs.modal", function () {
            console.log('Category modal shown');
            departmentSelect.innerHTML = '<option value="" disabled selected>-- Select Department --</option>';
            subDepartmentSelect.innerHTML = '<option value="" disabled selected>-- Select Sub-Department --</option>';
            document.getElementById("categoryForm").reset();
            document.getElementById("categoryForm").removeAttribute("data-id");
            document.getElementById("categoryForm").querySelector("button[type=submit]").textContent = "Add Category";
            loadCategoryList();
        });

        categoryModal.addEventListener("hidden.bs.modal", function () {
            console.log('Category modal hidden');
            const triggerElement = document.querySelector('[data-bs-target="#categoryModal"]');
            if (triggerElement) {
                triggerElement.focus();
            } else {
                document.body.focus();
            }
        });

        document.getElementById("categoryForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const form = this;
            const id = form.getAttribute("data-id");
            const url = id ? `/category/update/${id}/` : `/category/add/`;

            fetch(url, {
                method: "POST",
                headers: { "X-CSRFToken": getCSRFToken() },
                body: new FormData(form)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        form.reset();
                        form.removeAttribute("data-id");
                        form.querySelector("button[type=submit]").textContent = "Add Category";
                        loadCategoryList();
                    } else {
                        alert("Failed to save category: " + (data.error || "Unknown error"));
                    }
                })
                .catch(error => {
                    console.error('Error saving category:', error);
                    alert("Something went wrong.");
                });
        });
    });

    window.editCategory = function(id, name, companyId, departmentId, subDepartmentId, status) {
        console.log('editCategory called with:', { id, name, companyId, departmentId, subDepartmentId, status });
        const form = document.getElementById("categoryForm");
        if (!form) {
            console.error('Category form not found!');
            return;
        }
        form.setAttribute("data-id", id);
        form.querySelector("button[type=submit]").textContent = "Update Category";
        document.getElementById("category_id").value = id;
        document.getElementById("category_name").value = name;
        document.getElementById("category_company_name").value = companyId;
        document.getElementById("status").value = status;

        loadDepartments(companyId);
        document.getElementById("category_department").value = departmentId;
        if (departmentId) {
            loadSubDepartments(departmentId);
            document.getElementById("category_sub_department").value = subDepartmentId;
        }

        $('#categoryModal').modal('show');
    };

    window.deleteCategory = function(id) {
        if (confirm("Are you sure you want to delete this category?")) {
            fetch(`/category/delete/${id}/`, {
                method: "POST",
                headers: { "X-CSRFToken": getCSRFToken() }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        loadCategoryList();
                    } else {
                        alert("Failed to delete category: " + (data.error || "Unknown error"));
                    }
                })
                .catch(error => {
                    console.error('Error deleting category:', error);
                    alert("Something went wrong.");
                });
        }
    };
})();
</script>