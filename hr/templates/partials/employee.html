{% load static %}
<!-- Employee Modal -->
<div class="modal fade" id="employeeModal" tabindex="-1" aria-labelledby="employeeModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form id="employeeForm" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" id="employee_id" name="employee_id" value="">
                <!-- Hidden input for experiences -->
                <input type="hidden" name="emp_experiences" id="emp_experiences">
                <!-- Hidden input for assigned assets -->
                <input type="hidden" name="assigned_assets" id="assigned_assets">
                <div class="modal-header">
                    <h5 class="modal-title" id="employeeModalLabel">Add Employee</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Personal Details -->
                        <fieldset>
                            <legend>Personal Details</legend>
                            <div class="row g-3">
                                <!-- Employee ID (emp_id_branch) -->
                                <div class="col-md-6">
                                    <label for="emp_id_branch">Employee ID <span style="color: red;">*</span></label>
                                    <input type="text" class="form-control" name="emp_id_branch" id="emp_id_branch" pattern="[0-9]{7}" maxlength="7" required placeholder="7-digit ID (e.g., 1234567)">
                                    <div class="invalid-feedback">Employee ID must be exactly 7 digits.</div>
                                </div>
                                <!-- First Name -->
                                <div class="col-md-6">
                                    <label>First Name <span style="color: red;">*</span></label>
                                    <input type="text" class="form-control" name="emp_first_name" required>
                                </div>
                                <!-- Last Name -->
                                <div class="col-md-6">
                                    <label>Last Name</label>
                                    <input type="text" class="form-control" name="emp_last_name">
                                </div>
                                <!-- Aadhar Number -->
                                <div class="col-md-6">
                                    <label>Aadhar Number <span style="color: red;">*</span></label>
                                    <input type="text" class="form-control" name="emp_aadhar_number" id="emp_aadhar_number" pattern="[0-9]{12}" maxlength="12" placeholder="123456789012">
                                </div>
                                <!-- Photo -->
                                <div class="col-md-6">
                                    <label for="emp_photo">Photo</label>
                                    <input type="file" class="form-control" id="emp_photo" name="emp_photo" accept="image/*">
                                    <img id="photoPreview" src="#" alt="Image Preview" style="display: none; width: 100px; height: auto; margin-top: 10px;"/>
                                </div>
                                <!-- Date of Birth -->
                                <div class="col-md-6">
                                    <label>Date of Birth <span style="color: red;">*</span></label>
                                    <input type="date" class="form-control" name="emp_dob" required>
                                </div>
                                <!-- Mobile -->
                                <div class="col-md-6">
                                    <label>Mobile <span style="color: red;">*</span></label>
                                    <input type="text" class="form-control" name="emp_mobile" pattern="\+?\d{10,15}" required>
                                </div>
                                <!-- Secondary Mobile -->
                                <div class="col-md-6">
                                    <label>Secondary Mobile</label>
                                    <input type="text" class="form-control" name="emp_second_mobile" pattern="\+?\d{10,15}">
                                </div>
                                <!-- Email -->
                                <div class="col-md-6">
                                    <label>Email <span style="color: red;">*</span></label>
                                    <input type="email" class="form-control" name="emp_email" required>
                                </div>
                                <!-- Blood Group -->
                                <div class="col-md-6">
                                    <label>Blood Group <span style="color: red;">*</span></label>
                                    <select class="form-select" name="emp_blood_group" required>
                                        <option value="" disabled selected>-- Select Blood Group --</option>
                                        <option value="a+ve">A+</option>
                                        <option value="a-ve">A-</option>
                                        <option value="ab+ve">AB+</option>
                                        <option value="ab-ve">AB-</option>
                                        <option value="b+ve">B+</option>
                                        <option value="b-ve">B-</option>
                                        <option value="o+ve">O+</option>
                                        <option value="o-ve">O-</option>
                                    </select>
                                </div>
                                <!-- Gender -->
                                <div class="col-md-6">
                                    <label>Gender <span style="color: red;">*</span></label>
                                    <select class="form-select" name="emp_gender" required>
                                        <option value="" disabled selected>-- Select Gender --</option>
                                        <option value="female">Female</option>
                                        <option value="male">Male</option>
                                    </select>
                                </div>
                                <!-- Qualification -->
                                <div class="col-md-6">
                                    <label>Qualification <span style="color: red;">*</span></label>
                                    <select class="form-select" name="emp_qualification" required>
                                        <option value="" disabled selected>-- Qualification --</option>
                                        {% for qualification in qualifications|dictsort:"qualification_name" %}
                                        <option value="{{ qualification.id }}">{{ qualification.qualification_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <!-- Address -->
                                <div class="col-md-12">
                                    <label>Address <span style="color: red;">*</span></label>
                                    <textarea class="form-control" name="emp_address" rows="2" required></textarea>
                                </div>
                                <!-- Documents -->
                                <div class="col-md-6">
                                    <label for="emp_documents">Documents</label>
                                    <input type="file" class="form-control" id="emp_documents" name="emp_documents" accept=".pdf,.doc,.docx">
                                    <a id="documentPreview" href="#" target="_blank" style="display: none; margin-top: 10px;">View Document</a>
                                </div>
                            </div>
                        </fieldset>
                        <!-- Separator -->
                        <hr>
                        <!-- Professional Details -->
                        <fieldset>
                            <legend>Professional Details</legend>
                            <div class="row g-3">
                                <!-- Branch -->
                                <div class="col-md-6">
                                    <label>Branch <span style="color: red;">*</span></label>
                                    <select class="form-select" name="emp_branch" required>
                                        <option value="" disabled selected>-- Select Branch --</option>
                                        {% for branch in branches|dictsort:"name" %}
                                        <option value="{{ branch.id }}">{{ branch.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <!-- Company -->
                                <div class="col-md-6">
                                    <label>Company <span style="color: red;">*</span></label>
                                    <select class="form-select" name="emp_company" id="emp_company" required>
                                        <option value="" disabled selected>-- Select Company --</option>
                                        {% for company in companies|dictsort:"company_name" %}
                                        <option value="{{ company.id }}">{{ company.company_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <!-- Department -->
                                <div class="col-md-6">
                                    <label>Department <span style="color: red;">*</span></label>
                                    <select class="form-select" name="emp_department" id="emp_department" required>
                                        <option value="" disabled selected>-- Select Department --</option>
                                    </select>
                                </div>
                                <!-- Sub-Department -->
                                <div class="col-md-6">
                                    <label>Sub-Department <span style="color: red;">*</span></label>
                                    <select class="form-select" name="emp_sub_department" id="emp_sub_department" required>
                                        <option value="" disabled selected>-- Select Sub-Department --</option>
                                    </select>
                                </div>
                                <!-- Category -->
                                <div class="col-md-6">
                                    <label>Category <span style="color: red;">*</span></label>
                                    <select class="form-select" name="emp_category" id="emp_category" required>
                                        <option value="" disabled selected>-- Select Category --</option>
                                    </select>
                                </div>
                                <!-- Designation -->
                                <div class="col-md-6">
                                    <label>Designation <span style="color: red;">*</span></label>
                                    <select class="form-select" name="emp_designation" id="emp_designation" required>
                                        <option value="" disabled selected>-- Select Designation --</option>
                                    </select>
                                </div>
                                <!-- Salary -->
                                <div class="col-md-6">
                                    <label>Salary <span style="color: red;">*</span></label>
                                    <input type="number" step="0.01" class="form-control" name="emp_salary" required>
                                </div>
                                <!-- Joining Date -->
                                <div class="col-md-6">
                                    <label>Joining Date <span style="color: red;">*</span></label>
                                    <input type="date" class="form-control" name="emp_joining_date" required>
                                </div>
                                <!-- Resigning Date -->
                                <div class="col-md-6">
                                    <label>Resigning Date</label>
                                    <input type="date" class="form-control" name="emp_resigning_date">
                                </div>
                                <!-- Resigning Reason -->
                                <div class="col-md-6">
                                    <label>Resigning Reason</label>
                                    <textarea class="form-control" name="emp_resigning_reason" rows="2"></textarea>
                                </div>
                                <!-- Work Start Time -->
                                <div class="col-md-6">
                                    <label>Work Start Time <span style="color: red;">*</span></label>
                                    <input type="time" class="form-control" name="emp_work_start_time" required>
                                </div>
                                <!-- Work End Time -->
                                <div class="col-md-6">
                                    <label>Work End Time <span style="color: red;">*</span></label>
                                    <input type="time" class="form-control" name="emp_work_end_time" required>
                                </div>
                                <!-- Extra Skills -->
                                <div class="col-md-6">
                                    <label for="emp_extra_skills">Extra Skills</label>
                                    <input type="text" class="form-control" name="emp_extra_skills" id="emp_extra_skills" placeholder="Type skills (e.g., Python, Java)">
                                </div>
                                <!-- Status -->
                                <div class="col-md-6">
                                    <label>Status <span style="color: red;">*</span></label>
                                    <select class="form-select" name="emp_status" required>
                                        <option value="" disabled selected>-- Select Status --</option>
                                        <option value="active">Active</option>
                                        <option value="in-active">In Active</option>
                                    </select>
                                </div>
                                <!-- Assets -->
                                <div class="col-md-6 mt-3">
                                    <label for="emp_assets_dropdown" class="form-label">Select Asset to Assign</label>
                                    <div class="narrow-field d-flex align-items-center">
                                        <select class="form-select me-2" id="emp_assets_dropdown" name="emp_assets_dropdown">
                                            <option value="" selected disabled>Choose an asset...</option>
                                            {% for asset in assets|dictsort:"name" %}
                                            <option value="{{ asset.id }}">{{ asset.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <button type="button" class="btn btn-primary btn-sm" id="assign_asset_button">Submit</button>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#assetsModal">Manage Assets</button>
                                </div>
                                <!-- Assigned Assets -->
                                <div class="col-md-6 mt-3">
                                    <label class="form-label">Assigned Assets</label>
                                    <ul id="assigned_assets_list CHANNEL

System: list" class="list-group assigned-assets-list"></ul>
                                </div>
                                <!-- Remarks -->
                                <div class="col-md-12">
                                    <label>Remarks</label>
                                    <textarea class="form-control" name="emp_remarks" rows="2"></textarea>
                                </div>
                            </div>
                        </fieldset>
                        <!-- Separator -->
                        <hr>
                        <!-- Experience Details -->
                        <fieldset>
                            <legend>Experience Details</legend>
                            <div id="experience-container">
                                <!-- Initial experience entry -->
                                <div class="experience-entry row g-3 mb-3" data-index="0">
                                    <div class="col-md-6">
                                        <label>Company Name</label>
                                        <input type="text" class="form-control exp-company-name" data-field="company_name">
                                    </div>
                                    <div class="col-md-6">
                                        <label>Designation</label>
                                        <input type="text" class="form-control exp-designation" data-field="designation">
                                    </div>
                                    <div class="col-md-6">
                                        <label>Start Date</label>
                                        <input type="date" class="form-control exp-start-date" data-field="start_date">
                                    </div>
                                    <div class="col-md-5">
                                        <label>End Date</label>
                                        <input type="date" class="form-control exp-end-date" data-field="end_date">
                                    </div>
                                    <div class="col-md-1 d-flex align-items-end">
                                        <button type="button" class="btn btn-danger btn-sm remove-experience">Remove</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary mt-2" id="add-company">Add Experience</button>
                        </fieldset>
                    </div>
                </div>
                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success"><i class="bi bi-save"></i> Save</button>
                    <button type="reset" class="btn btn-secondary"><i class="bi bi-arrow-clockwise"></i> Reset</button>
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal"><i class="bi bi-x-circle"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .narrow-field {
        max-width: 300px;
    }
    .assigned-assets-list {
        max-width: 300px;
        max-height: 150px;
        overflow-y: auto;
    }
    .modal-content .form-select,
    .modal-content .list-group {
        width: 100%;
    }
    #assetsModal {
        z-index: 1060;
    }
    .modal-backdrop {
        z-index: 1040;
    }
    #employeeModal {
        z-index: 1050;
    }
    .tagify {
        width: 100%;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 0.375rem 0.75rem;
    }
    .tagify__tag {
        margin: 2px;
    }
    .is-invalid ~ .invalid-feedback {
        display: block;
    }
</style>

<script>
    // Initialize Tagify with autocomplete
    var input = document.getElementById('emp_extra_skills');
    var tagify = new Tagify(input, {
        whitelist: [],
        dropdown: {
            maxItems: 10,
            enabled: 0,
            closeOnSelect: false,
            searchKeys: ['value']
        },
        enforceWhitelist: false,
        originalInputValueFormat: valuesArr => valuesArr.map(item => item.value)
    });

    // Fetch skills for autocomplete
    tagify.on('input', function(e) {
        var value = e.detail.value;
        tagify.settings.whitelist.length = 0;
        if (value.length > 1) {
            fetch("{% url 'skill_list' %}?query=" + encodeURIComponent(value), {
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(response => response.json())
            .then(data => {
                // Sort skills alphabetically
                const sortedSkills = data.skills.sort((a, b) => a.name.localeCompare(b.name));
                tagify.settings.whitelist = sortedSkills.map(skill => ({ value: skill.name }));
                tagify.dropdown.show(value);
            })
            .catch(error => console.error("Error fetching skills:", error));
        }
    });

    // Track assigned assets for new employees
    let assignedAssetIds = [];

    // Format Employee ID (emp_id_branch)
    document.getElementById('emp_id_branch').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 7) {
            value = value.slice(0, 7);
        }
        e.target.value = value;
    });

    // Validate Employee ID on form submission
    document.getElementById('employeeForm').addEventListener('submit', function(e) {
        const empIdBranch = document.getElementById('emp_id_branch').value;
        const idRegex = /^[0-9]{7}$/;
        if (!idRegex.test(empIdBranch)) {
            e.preventDefault();
            document.getElementById('emp_id_branch').classList.add('is-invalid');
            alert('Employee ID must be exactly 7 digits.');
            return;
        }
    });

    // Format Aadhar Number
    document.getElementById('emp_aadhar_number').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 12) {
            value = value.slice(0, 12);
        }
        e.target.value = value;
    });

    // Document Preview
    document.getElementById('emp_documents').addEventListener('change', function(event) {
        const file = event.target.files[0];
        const documentPreview = document.getElementById('documentPreview');
        if (file) {
            const fileType = file.type;
            if (fileType === 'application/pdf' || fileType === 'application/msword' || fileType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                // For PDFs and Word documents, set the href to a placeholder or handle differently
                documentPreview.href = '#';
                documentPreview.textContent = `Selected: ${file.name}`;
                documentPreview.style.display = 'block';
            } else {
                documentPreview.href = '#';
                documentPreview.textContent = 'Unsupported file type';
                documentPreview.style.display = 'block';
            }
        } else {
            documentPreview.href = '#';
            documentPreview.textContent = 'View Document';
            documentPreview.style.display = 'none';
        }
    });

    // Dynamic Experience Handling
    let experienceIndex = 1;
    document.getElementById('add-company').addEventListener('click', function() {
        const newEntry = `
            <div class="experience-entry row g-3 mb-3" data-index="${experienceIndex}">
                <div class="col-md-6">
                    <label>Company Name</label>
                    <input type="text" class="form-control exp-company-name" data-field="company_name">
                </div>
                <div class="col-md-6">
                    <label>Designation</label>
                    <input type="text" class="form-control exp-designation" data-field="designation">
                </div>
                <div class="col-md-6">
                    <label>Start Date</label>
                    <input type="date" class="form-control exp-start-date" data-field="start_date">
                </div>
                <div class="col-md-5">
                    <label>End Date</label>
                    <input type="date" class="form-control exp-end-date" data-field="end_date">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-sm remove-experience">Remove</button>
                </div>
            </div>`;
        document.getElementById('experience-container').insertAdjacentHTML('beforeend', newEntry);
        experienceIndex++;
    });

    // Remove Experience Entry
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-experience')) {
            const entries = document.querySelectorAll('.experience-entry');
            if (entries.length > 1) {
                e.target.closest('.experience-entry').remove();
            } else {
                alert('At least one experience entry is required.');
            }
        }
    });

    // Form Submission
    document.getElementById('employeeForm').addEventListener('submit', function(event) {
        event.preventDefault();

        // Validate dates
        const dob = document.querySelector('input[name="emp_dob"]').value;
        const joiningDate = document.querySelector('input[name="emp_joining_date"]').value;
        const resigningDate = document.querySelector('input[name="emp_resigning_date"]').value;

        if (!dob || !joiningDate) {
            alert('Date of Birth and Joining Date are required.');
            return;
        }

        const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
        if (dob && !dateRegex.test(dob)) {
            alert('Date of Birth must be in YYYY-MM-DD format.');
            return;
        }
        if (joiningDate && !dateRegex.test(joiningDate)) {
            alert('Joining Date must be in YYYY-MM-DD format.');
            return;
        }
        if (resigningDate && !dateRegex.test(resigningDate)) {
            alert('Resigning Date must be in YYYY-MM-DD format.');
            return;
        }

        const formData = new FormData(this);

        // Collect experience data
        const experiences = [];
        document.querySelectorAll('.experience-entry').forEach(function(entry) {
            const experience = {
                company_name: entry.querySelector('.exp-company-name').value || '',
                designation: entry.querySelector('.exp-designation').value || '',
                start_date: entry.querySelector('.exp-start-date').value || null,
                end_date: entry.querySelector('.exp-end-date').value || null
            };
            if (experience.company_name || experience.designation || experience.start_date || experience.end_date) {
                experiences.push(experience);
            }
        });
        document.getElementById('emp_experiences').value = JSON.stringify(experiences);
        formData.set('emp_experiences', JSON.stringify(experiences));

        // Collect skills as JSON
        const skills = tagify.value.map(function(tag) { return tag.value; });
        formData.set('emp_extra_skills', JSON.stringify(skills));

        // Add assigned assets for new employees
        if (!document.getElementById('employee_id').value) {
            document.getElementById('assigned_assets').value = JSON.stringify(assignedAssetIds);
            formData.set('assigned_assets', JSON.stringify(assignedAssetIds));
        }

        fetch('{% url "add_employee" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Add employee response:', data);
            if (data.success) {
                document.getElementById('employeeModal').classList.remove('show');
                document.getElementById('employeeModal').style.display = 'none';
                document.querySelector('.modal-backdrop').remove();
                location.reload();
            } else {
                alert('Error saving employee data: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Add employee error:', error);
            alert('There was an issue submitting the form. Please try again.');
        });
    });

    // Photo Preview
    document.getElementById('emp_photo').addEventListener('change', function(event) {
        const file = event.target.files[0];
        const photoPreview = document.getElementById('photoPreview');
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                photoPreview.src = e.target.result;
                photoPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            photoPreview.src = '#';
            photoPreview.style.display = 'none';
        }
    });

    // Form Reset
    document.getElementById('employeeForm').addEventListener('reset', function() {
        this.reset();
        tagify.removeAllTags();
        document.getElementById('experience-container').innerHTML = `
            <div class="experience-entry row g-3 mb-3" data-index="0">
                <div class="col-md-6">
                    <label>Company Name</label>
                    <input type="text" class="form-control exp-company-name" data-field="company_name">
                </div>
                <div class="col-md-6">
                    <label>Designation</label>
                    <input type="text" class="form-control exp-designation" data-field="designation">
                </div>
                <div class="col-md-6">
                    <label>Start Date</label>
                    <input type="date" class="form-control exp-start-date" data-field="start_date">
                </div>
                <div class="col-md-5">
                    <label>End Date</label>
                    <input type="date" class="form-control exp-end-date" data-field="end_date">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-sm remove-experience">Remove</button>
                </div>
            </div>
        `;
        experienceIndex = 1;
        const photoPreview = document.getElementById('photoPreview');
        photoPreview.src = '#';
        photoPreview.style.display = 'none';
        const documentPreview = document.getElementById('documentPreview');
        documentPreview.href = '#';
        documentPreview.textContent = 'View Document';
        documentPreview.style.display = 'none';
        document.getElementById('assigned_assets_list').innerHTML = '';
        assignedAssetIds = [];
        document.getElementById('emp_id_branch').classList.remove('is-invalid');
        document.getElementById('employeeModalLabel').textContent = 'Add Employee';
        document.getElementById('emp_department').innerHTML = '<option value="" disabled selected>-- Select Department --</option>';
        document.getElementById('emp_sub_department').innerHTML = '<option value="" disabled selected>-- Select Sub-Department --</option>';
        document.getElementById('emp_category').innerHTML = '<option value="" disabled selected>-- Select Category --</option>';
        document.getElementById('emp_designation').innerHTML = '<option value="" disabled selected>-- Select Designation --</option>';
    });

    // Asset Management
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    document.getElementById('assign_asset_button').addEventListener('click', function() {
        const dropdown = document.getElementById('emp_assets_dropdown');
        const assetId = dropdown.value;
        const assetName = dropdown.options[dropdown.selectedIndex]?.text;
        if (!assetId) {
            alert('Please select an asset to assign.');
            return;
        }
        assignAsset(assetId, assetName);
        dropdown.value = '';
    });

    function assignAsset(assetId, assetName) {
        const assignedList = document.getElementById('assigned_assets_list');
        if (assignedList.querySelector(`[data-asset-id="${assetId}"]`)) {
            alert('Asset already assigned.');
            return;
        }
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.dataset.assetId = assetId;
        li.innerHTML = `${assetName} <button type="button" class="btn btn-sm btn-danger" onclick="removeAsset('${assetId}')">Remove</button>`;
        assignedList.appendChild(li);

        const employeeId = document.getElementById('employee_id').value;
        if (!employeeId) {
            if (!assignedAssetIds.includes(assetId)) {
                assignedAssetIds.push(assetId);
                console.log('Tracked asset for new employee:', assignedAssetIds);
            }
        } else {
            const formData = new FormData();
            formData.append('employee_id', employeeId);
            formData.append('asset_id', assetId);
            fetch('{% url "assign_asset" %}', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCSRFToken() },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                console.log('Assign asset response:', data);
                if (!data.success) {
                    alert('Failed to assign asset: ' + data.error);
                    li.remove();
                    assignedAssetIds = assignedAssetIds.filter(id => id !== assetId);
                }
            })
            .catch(error => {
                console.error('Error assigning asset:', error);
                alert('Error assigning asset. Please try again.');
                li.remove();
                assignedAssetIds = assignedAssetIds.filter(id => id !== assetId);
            });
        }
    }

    function removeAsset(assetId) {
        const assignedList = document.getElementById('assigned_assets_list');
        const li = assignedList.querySelector(`[data-asset-id="${assetId}"]`);
        if (!li) return;

        const employeeId = document.getElementById('employee_id').value;
        if (!employeeId) {
            assignedAssetIds = assignedAssetIds.filter(id => id !== assetId);
            li.remove();
            console.log('Removed asset from new employee:', assignedAssetIds);
        } else {
            const formData = new FormData();
            formData.append('employee_id', employeeId);
            formData.append('asset_id', assetId);
            fetch('{% url "remove_asset" %}', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCSRFToken() },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                console.log('Remove asset response:', data);
                if (data.success) {
                    li.remove();
                } else {
                    alert('Failed to remove asset: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error removing asset:', error);
                alert('Error removing asset. Please try again.');
            });
        }
    }

    function refreshAssetDropdown() {
        fetch('{% url "asset_list" %}', {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Asset list response:', data);
            const dropdown = document.getElementById('emp_assets_dropdown');
            const currentValue = dropdown.value;
            dropdown.innerHTML = '<option value="" selected disabled>Choose an asset...</option>';
            // Sort assets alphabetically
            const sortedAssets = data.assets.sort((a, b) => a.name.localeCompare(b.name));
            sortedAssets.forEach(asset => {
                const option = new Option(asset.name, asset.id);
                dropdown.appendChild(option);
            });
            dropdown.value = currentValue;
        })
        .catch(error => console.error('Error refreshing assets:', error));
    }

    // Functions to load dependent dropdowns
    function loadDepartments(companyId) {
        return fetch(`/department/by-company/${companyId}/`)
            .then(response => response.json())
            .then(data => {
                const deptSelect = document.getElementById('emp_department');
                deptSelect.innerHTML = '<option value="" disabled selected>-- Select Department --</option>';
                if (data.success && Array.isArray(data.departments)) {
                    // Sort departments alphabetically
                    const sortedDepartments = data.departments.sort((a, b) => a.department_name.localeCompare(b.department_name));
                    sortedDepartments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = dept.department_name;
                        deptSelect.appendChild(option);
                    });
                } else {
                    deptSelect.innerHTML = '<option value="" disabled selected>-- No Departments Available --</option>';
                }
            })
            .catch(error => {
                console.error('Error loading departments:', error);
                document.getElementById('emp_department').innerHTML = '<option value="" disabled selected>-- Select Department --</option>';
            });
    }

    function loadSubDepartments(departmentId) {
        return fetch(`/sub-department/by-department/${departmentId}/`)
            .then(response => response.json())
            .then(data => {
                const subDeptSelect = document.getElementById('emp_sub_department');
                subDeptSelect.innerHTML = '<option value="" disabled selected>-- Select Sub-Department --</option>';
                if (data.success && Array.isArray(data.subdepartments)) {
                    // Sort sub-departments alphabetically
                    const sortedSubDepartments = data.subdepartments.sort((a, b) => a.sub_department_name.localeCompare(b.sub_department_name));
                    sortedSubDepartments.forEach(subDept => {
                        const option = document.createElement('option');
                        option.value = subDept.id;
                        option.textContent = subDept.sub_department_name;
                        subDeptSelect.appendChild(option);
                    });
                } else {
                    subDeptSelect.innerHTML = '<option value="" disabled selected>-- No Sub-Departments Available --</option>';
                }
            })
            .catch(error => {
                console.error('Error loading sub-departments:', error);
                document.getElementById('emp_sub_department').innerHTML = '<option value="" disabled selected>-- Select Sub-Department --</option>';
            });
    }

    function loadCategories(subDepartmentId) {
        return fetch(`/category/by-subdepartment/${subDepartmentId}/`)
            .then(response => response.json())
            .then(data => {
                const categorySelect = document.getElementById('emp_category');
                categorySelect.innerHTML = '<option value="" disabled selected>-- Select Category --</option>';
                if (data.success && Array.isArray(data.categories)) {
                    // Sort categories alphabetically
                    const sortedCategories = data.categories.sort((a, b) => a.category_name.localeCompare(b.category_name));
                    sortedCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.category_name;
                        categorySelect.appendChild(option);
                    });
                } else {
                    categorySelect.innerHTML = '<option value="" disabled selected>-- No Categories Available --</option>';
                }
            })
            .catch(error => {
                console.error('Error loading categories:', error);
                document.getElementById('emp_category').innerHTML = '<option value="" disabled selected>-- Select Category --</option>';
            });
    }

    function loadDesignations(categoryId) {
        return fetch(`/designation/by-category/${categoryId}/`)
            .then(response => response.json())
            .then(data => {
                const desigSelect = document.getElementById('emp_designation');
                desigSelect.innerHTML = '<option value="" disabled selected>-- Select Designation --</option>';
                if (data.success && Array.isArray(data.designations)) {
                    // Sort designations alphabetically
                    const sortedDesignations = data.designations.sort((a, b) => a.designation_name.localeCompare(b.designation_name));
                    sortedDesignations.forEach(desig => {
                        const option = document.createElement('option');
                        option.value = desig.id;
                        option.textContent = desig.designation_name;
                        desigSelect.appendChild(option);
                    });
                } else {
                    desigSelect.innerHTML = '<option value="" disabled selected>-- No Designations Available --</option>';
                }
            })
            .catch(error => {
                console.error('Error loading designations:', error);
                document.getElementById('emp_designation').innerHTML = '<option value="" disabled selected>-- Select Designation --</option>';
            });
    }

    // Event listeners for dropdown changes
    document.getElementById('emp_company').addEventListener('change', function() {
        const companyId = this.value;
        document.getElementById('emp_department').innerHTML = '<option value="" disabled selected>-- Select Department --</option>';
        document.getElementById('emp_sub_department').innerHTML = '<option value="" disabled selected>-- Select Sub-Department --</option>';
        document.getElementById('emp_category').innerHTML = '<option value="" disabled selected>-- Select Category --</option>';
        document.getElementById('emp_designation').innerHTML = '<option value="" disabled selected>-- Select Designation --</option>';
        if (companyId) {
            loadDepartments(companyId);
        }
    });

    document.getElementById('emp_department').addEventListener('change', function() {
        const departmentId = this.value;
        document.getElementById('emp_sub_department').innerHTML = '<option value="" disabled selected>-- Select Sub-Department --</option>';
        document.getElementById('emp_category').innerHTML = '<option value="" disabled selected>-- Select Category --</option>';
        document.getElementById('emp_designation').innerHTML = '<option value="" disabled selected>-- Select Designation --</option>';
        if (departmentId) {
            loadSubDepartments(departmentId);
        }
    });

    document.getElementById('emp_sub_department').addEventListener('change', function() {
        const subDepartmentId = this.value;
        document.getElementById('emp_category').innerHTML = '<option value="" disabled selected>-- Select Category --</option>';
        document.getElementById('emp_designation').innerHTML = '<option value="" disabled selected>-- Select Designation --</option>';
        if (subDepartmentId) {
            loadCategories(subDepartmentId);
        }
    });

    document.getElementById('emp_category').addEventListener('change', function() {
        const categoryId = this.value;
        document.getElementById('emp_designation').innerHTML = '<option value="" disabled selected>-- Select Designation --</option>';
        if (categoryId) {
            loadDesignations(categoryId);
        }
    });

    // Edit Employee Button Click
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-employee')) {
            const employeeId = e.target.dataset.employeeId;
            console.log('Fetching employee data for ID:', employeeId);

            fetch(`{% url 'get_employee_for_edit' employee_id=0 %}`.replace('0', employeeId), {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(response => {
                console.log('Get employee response:', response);
                if (response.success) {
                    populateEmployeeForm(response.employee);
                    document.getElementById('employeeModalLabel').textContent = 'Edit Employee';
                    document.getElementById('employeeModal').classList.add('show');
                    document.getElementById('employeeModal').style.display = 'block';
                    document.body.classList.add('modal-open');
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    document.body.appendChild(backdrop);
                } else {
                    alert('Error fetching employee data: ' + response.error);
                }
            })
            .catch(error => {
                console.error('Error fetching employee:', error);
                alert('There was an issue fetching the employee data. Please try again.');
            });
        }
    });

    // Function to populate the form with employee data
    function populateEmployeeForm(employee) {
        // Reset the form to clear any previous data
        const form = document.getElementById('employeeForm');
        form.reset();
        tagify.removeAllTags();
        document.getElementById('experience-container').innerHTML = `
            <div class="experience-entry row g-3 mb-3" data-index="0">
                <div class="col-md-6">
                    <label>Company Name</label>
                    <input type="text" class="form-control exp-company-name" data-field="company_name">
                </div>
                <div class="col-md-6">
                    <label>Designation</label>
                    <input type="text" class="form-control exp-designation" data-field="designation">
                </div>
                <div class="col-md-6">
                    <label>Start Date</label>
                    <input type="date" class="form-control exp-start-date" data-field="start_date">
                </div>
                <div class="col-md-5">
                    <label>End Date</label>
                    <input type="date" class="form-control exp-end-date" data-field="end_date">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-sm remove-experience">Remove</button>
                </div>
            </div>
        `;
        const photoPreview = document.getElementById('photoPreview');
        photoPreview.src = '#';
        photoPreview.style.display = 'none';
        const documentPreview = document.getElementById('documentPreview');
        documentPreview.href = '#';
        documentPreview.textContent = 'View Document';
        documentPreview.style.display = 'none';
        document.getElementById('assigned_assets_list').innerHTML = '';
        assignedAssetIds = [];
        experienceIndex = 1;

        // Populate personal details
        document.getElementById('employee_id').value = employee.id || '';
        document.getElementById('emp_id_branch').value = employee.emp_id_branch || '';
        document.querySelector('input[name="emp_first_name"]').value = employee.emp_first_name || '';
        document.querySelector('input[name="emp_last_name"]').value = employee.emp_last_name || '';
        document.querySelector('input[name="emp_aadhar_number"]').value = employee.emp_aadhar_number || '';
        document.querySelector('input[name="emp_dob"]').value = employee.emp_dob || '';
        document.querySelector('input[name="emp_mobile"]').value = employee.emp_mobile || '';
        document.querySelector('input[name="emp_second_mobile"]').value = employee.emp_second_mobile || '';
        document.querySelector('input[name="emp_email"]').value = employee.emp_email || '';
        document.querySelector('select[name="emp_blood_group"]').value = employee.emp_blood_group || '';
        document.querySelector('select[name="emp_gender"]').value = employee.emp_gender || '';
        document.querySelector('select[name="emp_qualification"]').value = employee.emp_qualification?.id || '';
        document.querySelector('textarea[name="emp_address"]').value = employee.emp_address || '';

        // Populate professional details
        document.querySelector('select[name="emp_branch"]').value = employee.emp_branch?.id || '';
        document.querySelector('select[name="emp_company"]').value = employee.emp_company?.id || '';
        document.querySelector('input[name="emp_salary"]').value = employee.emp_salary || '';
        document.querySelector('input[name="emp_joining_date"]').value = employee.emp_joining_date || '';
        document.querySelector('input[name="emp_resigning_date"]').value = employee.emp_resigning_date || '';
        document.querySelector('textarea[name="emp_resigning_reason"]').value = employee.emp_resigning_reason || '';
        document.querySelector('input[name="emp_work_start_time"]').value = employee.emp_work_start_time || '';
        document.querySelector('input[name="emp_work_end_time"]').value = employee.emp_work_end_time || '';
        document.querySelector('select[name="emp_status"]').value = employee.emp_status || '';
        document.querySelector('textarea[name="emp_remarks"]').value = employee.emp_remarks || '';

        // Populate skills
        if (employee.emp_extra_skills && employee.emp_extra_skills.length) {
            tagify.addTags(employee.emp_extra_skills.map(skill => skill.name));
        }

        // Populate experiences
        if (employee.emp_experiences && employee.emp_experiences.length) {
            document.getElementById('experience-container').innerHTML = '';
            employee.emp_experiences.forEach((exp, index) => {
                const entryHtml = `
                    <div class="experience-entry row g-3 mb-3" data-index="${index}">
                        <div class="col-md-6">
                            <label>Company Name</label>
                            <input type="text" class="form-control exp-company-name" data-field="company_name" value="${exp.company_name || ''}">
                        </div>
                        <div class="col-md-6">
                            <label>Designation</label>
                            <input type="text" class="form-control exp-designation" data-field="designation" value="${exp.designation || ''}">
                        </div>
                        <div class="col-md-6">
                            <label>Start Date</label>
                            <input type="date" class="form-control exp-start-date" data-field="start_date" value="${exp.start_date || ''}">
                        </div>
                        <div class="col-md-5">
                            <label>End Date</label>
                            <input type="date" class="form-control exp-end-date" data-field="end_date" value="${exp.end_date || ''}">
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-danger btn-sm remove-experience">Remove</button>
                        </div>
                    </div>`;
                document.getElementById('experience-container').insertAdjacentHTML('beforeend', entryHtml);
                experienceIndex = index + 1;
            });
        }

        // Populate assigned assets
        if (employee.emp_assets && employee.emp_assets.length) {
            employee.emp_assets.forEach(asset => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.dataset.assetId = asset.id;
                li.innerHTML = `${asset.name} <button type="button" class="btn btn-sm btn-danger" onclick="removeAsset('${asset.id}')">Remove</button>`;
                document.getElementById('assigned_assets_list').appendChild(li);
                if (!employee.id) {
                    assignedAssetIds.push(asset.id);
                }
            });
        }

        // Show photo preview if exists
        if (employee.emp_photo) {
            photoPreview.src = employee.emp_photo;
            photoPreview.style.display = 'block';
        }

        // Show document preview if exists
        if (employee.emp_documents) {
            documentPreview.href = employee.emp_documents;
            documentPreview.textContent = 'View Document';
            documentPreview.style.display = 'block';
        }

        // Populate dependent dropdowns
        if (employee.emp_company?.id) {
            document.getElementById('emp_company').value = employee.emp_company.id;
            loadDepartments(employee.emp_company.id).then(() => {
                document.getElementById('emp_department').value = employee.emp_department?.id || '';
                if (employee.emp_department?.id) {
                    return loadSubDepartments(employee.emp_department.id);
                }
            }).then(() => {
                document.getElementById('emp_sub_department').value = employee.emp_sub_department?.id || '';
                if (employee.emp_sub_department?.id) {
                    return loadCategories(employee.emp_sub_department.id);
                }
            }).then(() => {
                document.getElementById('emp_category').value = employee.emp_category?.id || '';
                if (employee.emp_category?.id) {
                    return loadDesignations(employee.emp_category.id);
                }
            }).then(() => {
                document.getElementById('emp_designation').value = employee.emp_designation?.id || '';
            }).catch(error => {
                console.error('Error populating dependent dropdowns:', error);
            });
        }
    }

    // Reset form when modal is hidden
    document.getElementById('employeeModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('employeeForm').reset();
        document.getElementById('employeeForm').action = '{% url "add_employee" %}';
    });
</script>