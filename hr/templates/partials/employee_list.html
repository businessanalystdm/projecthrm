{% load static %}
<div id="employeeListBox" class="card mt-3" data-list-type="active">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
            <input type="text" class="form-control form-control-sm" id="employeeSearch"
                   placeholder="Search by name...">
            <button class="btn btn-sm btn-primary" onclick="filterEmployees()">Search</button>
            <input type="text" class="form-control form-control-sm" id="skillSearch"
                   placeholder="Search by skill...">
            <button class="btn btn-sm btn-primary" onclick="filterEmployees()">Search</button>
            <div class="dropdown">
                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="filterDropdown"
                        data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-filter me-1"></i> Filter
                </button>
                <div class="dropdown-menu p-3" aria-labelledby="filterDropdown" style="width: 300px;">
                    <h6 class="dropdown-header">Filter Employees</h6>
                    <div class="mb-2">
                        <label for="filterGender" class="form-label small">Gender</label>
                        <select class="form-select form-select-sm" id="filterGender">
                            <option value="">All Genders</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="filterCompany" class="form-label small">Company</label>
                        <select class="form-select form-select-sm" id="filterCompany">
                            <option value="">All Companies</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}">{{ company.company_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="filterDepartment" class="form-label small">Department</label>
                        <select class="form-select form-select-sm" id="filterDepartment">
                            <option value="">All Departments</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}">{{ dept.department_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="filterSubDepartment" class="form-label small">Sub-Department</label>
                        <select class="form-select form-select-sm" id="filterSubDepartment">
                            <option value="">All Sub-Departments</option>
                            {% for sub_dept in sub_departments %}
                            <option value="{{ sub_dept.id }}">{{ sub_dept.sub_department_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="filterCategory" class="form-label small">Category</label>
                        <select class="form-select form-select-sm" id="filterCategory">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.category_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="filterDesignation" class="form-label small">Designation</label>
                        <select class="form-select form-select-sm" id="filterDesignation">
                            <option value="">All Roles</option>
                            {% for designation in designations %}
                            <option value="{{ designation.id }}">{{ designation.designation_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="filterQualification" class="form-label small">Qualification</label>
                        <select class="form-select form-select-sm" id="filterQualification">
                            <option value="">All Qualifications</option>
                            {% for qual in qualifications %}
                            <option value="{{ qual.id }}">{{ qual.qualification_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="filterZone" class="form-label small">Zone of Operations</label>
                        <select class="form-select form-select-sm" id="filterZone">
                            <option value="">All Zones</option>
                            {% for zone in zones %}
                            <option value="{{ zone.id }}">{{ zone.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="filterBranch" class="form-label small">Branch</label>
                        <select class="form-select form-select-sm" id="filterBranch">
                            <option value="">All Branches</option>
                            {% for branch in branches %}
                            <option value="{{ branch.id }}">{{ branch.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button class="btn btn-primary btn-sm w-100 mt-2" onclick="filterEmployees()">Apply Filters</button>
                </div>
            </div>
            <div class="dropdown">
                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="sortDropdown"
                        data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-sort me-1"></i> Sort By
                </button>
                <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                    <li><a class="dropdown-item" href="#" onclick="sortEmployees('name', 'asc'); return false;">Name:
                        A-Z</a></li>
                    <li><a class="dropdown-item" href="#" onclick="sortEmployees('name', 'desc'); return false;">Name:
                        Z-A</a></li>
                    <li><a class="dropdown-item" href="#" onclick="sortEmployees('joining_date', 'asc'); return false;">Joining
                        Date: Oldest First</a></li>
                    <li><a class="dropdown-item" href="#"
                           onclick="sortEmployees('joining_date', 'desc'); return false;">Joining Date: Newest First</a>
                    </li>
                    <li><a class="dropdown-item" href="#" onclick="sortEmployees('designation', 'asc'); return false;">Designation:
                        Highest Rank First</a></li>
                    <li><a class="dropdown-item" href="#" onclick="sortEmployees('designation', 'desc'); return false;">Designation:
                        Lowest Rank First</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if no_branches_message %}
        <div class="alert alert-warning">{{ no_branches_message }}</div>
        {% elif employees %}
        <table class="table table-striped table-bordered">
            <thead>
            <tr>
                <th>Sl</th>
                <th>Full Name</th>
                <th>Employee ID</th>
                <th>Company</th>
                <th>Branch</th>
                <th>Department</th>
                <th>Designation</th>
                <th>Duration</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody id="employeeTableBody">
            {% for emp in employees %}
            <tr class="{% if emp.emp_status == 'inactive' %}table-danger{% endif %} {% if emp.is_rating_due %}bg-alert{% endif %}"
                data-employee-id="{{ emp.id }}"
                data-employee-name="{{ emp.emp_first_name }} {{ emp.emp_last_name|default:'' }}"
                data-emp-id-branch="{{ emp.emp_id_branch }}"
                data-skills="{% for skill in emp.emp_extra_skills.all %}{{ skill.name|lower }}{% if not forloop.last %},{% endif %}{% endfor %}"
                data-company-id="{{ emp.emp_company.id|default_if_none:0 }}"
                data-department-id="{{ emp.emp_department.id|default_if_none:0 }}"
                data-sub-department-id="{{ emp.emp_sub_department.id|default_if_none:0 }}"
                data-category-id="{{ emp.emp_category.id|default_if_none:0 }}"
                data-designation-id="{{ emp.emp_designation.id|default_if_none:0 }}"
                data-qualification-id="{{ emp.emp_qualification.id|default_if_none:0 }}"
                data-zone-id="{{ emp.emp_branch.zone.id|default_if_none:0 }}"
                data-branch-id="{{ emp.emp_branch.id|default_if_none:0 }}"
                data-gender="{{ emp.emp_gender }}"
                data-joining-date="{{ emp.emp_joining_date|date:'Y-m-d' }}"
                data-designation-rank="{% if emp.emp_designation %}{{ emp.emp_designation.rank }}{% else %}999999{% endif %}"
                data-matches="true">
                <td class="serial-number">{{ forloop.counter }}</td>
                <td>{{ emp.emp_first_name }} {{ emp.emp_last_name|default:'' }}</td>
                <td>{{ emp.emp_id_branch }}</td>
                <td>{{ emp.emp_company.company_name|default:"N/A" }}</td>
                <td>{{ emp.emp_branch.name|default:"N/A" }}</td>
                <td>{{ emp.emp_department.department_name|default:"N/A" }}</td>
                <td>{{ emp.emp_designation.designation_name|default:"N/A" }}</td>
                <td>{{ emp.work_duration|default:0 }} days</td>
                <td>
                    <span class="badge bg-{% if emp.emp_status == 'active' %}success{% else %}danger{% endif %}">
                        {{ emp.emp_status|title }}
                    </span>
                </td>
                <td>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
                            data-bs-target="#viewEmployeeModal"
                            onclick="loadEmployeeDetails({{ emp.id }})" title="View">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-warning btn-sm edit-employee" data-employee-id="{{ emp.id }}" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-success btn-sm upgrade-btn" data-employee-id="{{ emp.id }}" title="Upgrade">
                        <i class="bi bi-arrow-up-circle"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteEmployee({{ emp.id }})" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
            <tr id="noMatchesRow" style="display:none;">
                <td colspan="10">No matching employees found.</td>
            </tr>
            </tbody>
        </table>
        <nav aria-label="Employee pagination">
            <ul class="pagination justify-content-center mt-3" id="paginationControls"></ul>
        </nav>
        {% else %}
        <p>No employees found.</p>
        {% endif %}
    </div>
</div>

<!-- View Employee Modal -->
<div class="modal fade" id="viewEmployeeModal" tabindex="-1" aria-labelledby="viewEmployeeModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-custom-75 modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="viewEmployeeModalLabel">
                    <i class="bi bi-person-circle me-2"></i>Employee Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" id="employeeDetailsBody">
                <p>Loading employee details...</p>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="btn btn-danger btn-sm" id="resignEmployeeBtn" data-employee-id="">
                    <i class="bi bi-person-x me-1"></i>Resign
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Resignation Confirmation Modal -->
<div class="modal fade" id="resignationConfirmModal" tabindex="-1" aria-labelledby="resignationConfirmModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="resignationConfirmModalLabel">
                    <i class="bi bi-person-x me-2"></i>Confirm Resignation
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Please enter the resignation date for the employee.</p>
                <div class="mb-3">
                    <label for="resignationDate" class="form-label">Resignation Date</label>
                    <input type="date" class="form-control" id="resignationDate" name="emp_resigning_date" required>
                    <div class="invalid-feedback">Please select a valid resignation date (today or past).</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmResignationDateBtn">Confirm Resignation</button>
            </div>
        </div>
    </div>
</div>

<!-- Asset Handover Modal -->
<div class="modal fade" id="assetHandoverModal" tabindex="-1" aria-labelledby="assetHandoverModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="assetHandoverModalLabel">
                    <i class="bi bi-box-arrow-in-down me-2"></i>Confirm Asset Handover
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Please confirm that the following assets have been handed over:</p>
                <div id="assetCheckboxList"></div>
                <div id="assetError" class="alert alert-danger mt-2" style="display: none;">
                    Please check all assets to confirm handover.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmResignBtn">Confirm Resignation</button>
            </div>
        </div>
    </div>
</div>

<!-- Upgrade Employee Modal -->
<div class="modal fade" id="upgradeModal" tabindex="-1" aria-labelledby="upgradeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="upgradeModalLabel">Upgrade Employee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="upgradeTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="branch-transfer-tab" data-bs-toggle="tab"
                                data-bs-target="#branch-transfer" type="button" role="tab"
                                aria-controls="branch-transfer" aria-selected="true">Branch Transfer
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="salary-increment-tab" data-bs-toggle="tab"
                                data-bs-target="#salary-increment" type="button" role="tab"
                                aria-controls="salary-increment" aria-selected="false">Salary Increment
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="promotion-tab" data-bs-toggle="tab" data-bs-target="#promotion"
                                type="button" role="tab" aria-controls="promotion" aria-selected="false">Promotion
                        </button>
                    </li>
                </ul>
                <div class="tab-content mt-3" id="upgradeTabContent">
                    <!-- Branch Transfer Tab -->
                    <div class="tab-pane fade show active" id="branch-transfer" role="tabpanel"
                         aria-labelledby="branch-transfer-tab">
                        <form id="branchTransferForm" method="POST" action="/transfer_branch/">
                            {% csrf_token %}
                            <input type="hidden" id="branchTransferEmployeeId" name="employee_id">
                            <div class="mb-3">
                                <label for="currentBranch" class="form-label">Current Branch</label>
                                <input type="text" class="form-control" id="currentBranch" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="newBranch" class="form-label">New Branch</label>
                                <select class="form-select" id="newBranch" name="branch_id" required>
                                    <option value="">Select Branch</option>
                                    {% for branch in branches %}
                                    <option value="{{ branch.id }}">{{ branch.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Please select a branch.</div>
                            </div>
                            <div class="mb-3">
                                <label for="startDate" class="form-label">Transfer Date</label>
                                <input type="date" class="form-control" id="startDate" name="start_date" required
                                       value="{{ today|date:'Y-m-d' }}">
                                <div class="invalid-feedback">Please select a valid date (today or future).</div>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit Branch Transfer</button>
                        </form>
                    </div>
                    <!-- Salary Increment Tab -->
                    <div class="tab-pane fade" id="salary-increment" role="tabpanel"
                         aria-labelledby="salary-increment-tab">
                        <form id="salaryIncrementForm" method="POST" action="/increment_salary/">
                            {% csrf_token %}
                            <input type="hidden" id="salaryIncrementEmployeeId" name="employee_id">
                            <div class="mb-3 d-flex align-items-end gap-3">
                                <div class="flex-grow-1">
                                    <label for="newSalary" class="form-label">New Salary</label>
                                    <input type="number" class="form-control" id="newSalary" name="salary"
                                           step="0.01" min="0.01" required>
                                    <div class="invalid-feedback">Please enter a valid salary greater than the current
                                        salary.
                                    </div>
                                </div>
                                <div class="flex-shrink-0">
                                    <label for="currentSalary" class="form-label">Current Salary</label>
                                    <input type="text" class="form-control" id="currentSalary" readonly>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="salaryStartDate" class="form-label">Salary Change Date</label>
                                <input type="date" class="form-control" id="salaryStartDate" name="start_date" required
                                       value="{{ today|date:'Y-m-d' }}">
                                <div class="invalid-feedback">Please select a valid date (today or future).</div>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit Salary Increment</button>
                        </form>
                    </div>
                    <!-- Promotion Tab -->
                    <div class="tab-pane fade" id="promotion" role="tabpanel" aria-labelledby="promotion-tab">
                        <form id="promotionForm" method="POST" action="/promote_employee/">
                            {% csrf_token %}
                            <input type="hidden" id="promotionEmployeeId" name="employee_id">
                            <div class="mb-3 d-flex align-items-end gap-3">
                                <div class="flex-grow-1">
                                    <label for="newDepartment" class="form-label">New Department</label>
                                    <select class="form-select" id="newDepartment" name="department_id" required>
                                        <option value="" disabled selected>-- Select Department --</option>
                                    </select>
                                    <div class="invalid-feedback">Please select a department.</div>
                                </div>
                                <div class="flex-shrink-0">
                                    <label for="currentDepartment" class="form-label">Current Department</label>
                                    <input type="text" class="form-control" id="currentDepartment" readonly>
                                </div>
                            </div>
                            <div class="mb-2 d-flex align-items-end gap-3">
                                <div class="flex-grow-1">
                                    <label for="newSubDepartment" class="form-label">New Sub-Department</label>
                                    <select class="form-select" id="newSubDepartment" name="sub_department_id" required>
                                        <option value="" disabled selected>-- Select Sub-Department --</option>
                                    </select>
                                    <div class="invalid-feedback">Please select a sub-department.</div>
                                </div>
                                <div class="flex-shrink-0">
                                    <label for="currentSubDepartment" class="form-label">Current Sub-Department</label>
                                    <input type="text" class="form-control" id="currentSubDepartment" readonly>
                                </div>
                            </div>
                            <div class="mb-3 d-flex align-items-end gap-3">
                                <div class="flex-grow-1">
                                    <label for="newCategory" class="form-label">New Category</label>
                                    <select class="form-select" id="newCategory" name="category_id" required>
                                        <option value="" disabled selected>-- Select Category --</option>
                                    </select>
                                    <div class="invalid-feedback">Please select a category.</div>
                                </div>
                                <div class="flex-shrink-0">
                                    <label for="currentCategory" class="form-label">Current Category</label>
                                    <input type="text" class="form-control" id="currentCategory" readonly>
                                </div>
                            </div>
                            <div class="mb-3 d-flex align-items-end gap-3">
                                <div class="flex-grow-1">
                                    <label for="newDesignation" class="form-label">New Designation</label>
                                    <select class="form-select" id="newDesignation" name="designation_id" required>
                                        <option value="" disabled selected>-- Select Designation --</option>
                                    </select>
                                    <div class="invalid-feedback">Please select a designation.</div>
                                </div>
                                <div class="flex-shrink-0">
                                    <label for="currentDesignation" class="form-label">Current Designation</label>
                                    <input type="text" class="form-control" id="currentDesignation" readonly>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="promotionStartDate" class="form-label">Promotion Date</label>
                                <input type="date" class="form-control" id="promotionStartDate" name="start_date"
                                       required value="{{ today|date:'Y-m-d' }}">
                                <div class="invalid-feedback">Please select a promotion date.</div>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit Promotion</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-alert { background-color: #FFA07A !important; }
    .modal-custom-75 { max-width: 75vw; width: 75vw; margin-left: auto; margin-right: auto; }
    .modal-content { border-radius: 0.5rem; overflow-y: auto; max-height: 80vh; }
    .modal-body { background-color: #f8f9fa; }
    .card { border: none; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
    .table { border-radius: 0.25rem; overflow: hidden; }
    .table-hover tbody tr:hover { background-color: #e9ecef; }
    .badge.bg-success { background-color: #28a745 !important; }
    .badge.bg-danger { background-color: #dc3545 !important; }
    .btn-sm { padding: 0.25rem 0.5rem; }
    .pagination .page-link { cursor: pointer; }
    .nav-tabs .nav-link { border-radius: 0.25rem; }
    .tab-content { padding: 1rem; }
    .form-control[readonly] { background-color: #e9ecef; }
    @media (max-width: 767.98px) {
        .modal-custom-75 { max-width: 95vw; width: 95vw; }
        .modal-content { max-height: 100vh; }
        .table { font-size: 0.875rem; }
        .btn-sm { padding: 0.2rem 0.4rem; font-size: 0.75rem; }
        .d-flex.align-items-end.gap-3 { flex-direction: column; align-items: stretch; }
        .d-flex.align-items-end.gap-3 > div { width: 100%; }
    }
</style>

<script>
    let currentPage = 1;
const recordsPerPage = 25;
let currentSortField = null;
let currentSortOrder = null;

$(document).on('click', '.edit-employee', function() {
    const employeeId = $(this).data('employee-id');
    console.log('Fetching employee data for ID:', employeeId);
    $.ajax({
        url: `/get_employee_for_edit/${employeeId}/`,
        type: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function(response) {
            console.log('Get employee response:', response);
            if (response.success) {
                populateEmployeeForm(response.employee);
                $('#employeeModalLabel').text('Edit Employee');
                $('#employeeModal').modal('show');
            } else {
                alert('Error fetching employee data: ' + response.error);
            }
        },
        error: function(xhr) {
            console.error('Error fetching employee:', xhr.status, xhr.statusText);
            alert('There was an issue fetching the employee data. Please try again.');
        }
    });
});

$(document).on('click', '.upgrade-btn', function() {
    const $row = $(this).closest('tr');
    const employeeId = $row.data('employee-id');
    const companyId = $row.data('company-id');
    console.log('Employee ID:', employeeId, 'Company ID:', companyId);
    upgradeModal(employeeId, companyId);
});

$(document).on('click', '#resignEmployeeBtn', function() {
    const $btn = $(this);
    const employeeId = $btn.attr('data-employee-id');
    if (!employeeId) {
        console.error('No employee ID for resignation');
        alert('No employee selected.');
        return;
    }
    console.log('Resign button clicked for employee ID:', employeeId);
    $btn.prop('disabled', true);
    $('#resignationDate').val(new Date().toISOString().split('T')[0]);
    $('#resignationConfirmModal').modal('show').data('employee-id', employeeId);
    $btn.prop('disabled', false);
});

$(document).on('click', '#confirmResignationDateBtn', function() {
    const $btn = $(this);
    $btn.prop('disabled', true);
    const employeeId = $('#resignationConfirmModal').data('employee-id');
    const resignationDate = $('#resignationDate').val();
    if (!employeeId) {
        console.error('No employee ID for resignation confirmation');
        alert('No employee selected.');
        $btn.prop('disabled', false);
        return;
    }
    if (!resignationDate) {
        $('#resignationDate').addClass('is-invalid');
        alert('Please select a resignation date.');
        $btn.prop('disabled', false);
        return;
    }
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const selectedDate = new Date(resignationDate);
    selectedDate.setHours(0, 0, 0, 0);
    if (selectedDate > today) {
        $('#resignationDate').addClass('is-invalid');
        alert('Resignation date cannot be in the future.');
        $btn.prop('disabled', false);
        return;
    }
    $('#resignationConfirmModal').modal('hide').data('resignation-date', resignationDate);
    $('#assetCheckboxList').empty();
    $('#assetError').hide();
    $.ajax({
        url: '/get_employee_assets/',
        type: 'GET',
        data: { employee_id: employeeId },
        success: function(response) {
            if (response.success) {
                if (response.assets.length > 0) {
                    let checkboxHtml = '';
                    response.assets.forEach(asset => {
                        checkboxHtml += `
                            <div class="form-check">
                                <input class="form-check-input asset-checkbox" type="checkbox" value="${asset.id}" id="asset_${asset.id}">
                                <label class="form-check-label" for="asset_${asset.id}">
                                    ${asset.name}
                                </label>
                            </div>`;
                    });
                    $('#assetCheckboxList').html(checkboxHtml);
                    $('#assetHandoverModal').modal('show');
                } else {
                    proceedWithResignation(employeeId, resignationDate);
                }
            } else {
                console.error('Asset fetch error:', response.error);
                alert('Error: ' + response.error);
            }
        },
        error: function(xhr) {
            console.error('Error fetching assets:', xhr.status, xhr.statusText);
            alert('Failed to load assets.');
        },
        complete: function() {
            $btn.prop('disabled', false);
        }
    });
});

$(document).on('click', '#confirmResignBtn', function() {
    const $btn = $(this);
    $btn.prop('disabled', true);
    const allChecked = $('.asset-checkbox').length === $('.asset-checkbox:checked').length;
    if ($('.asset-checkbox').length > 0 && !allChecked) {
        $('#assetError').show();
        $btn.prop('disabled', false);
        return;
    }
    const employeeId = $('#resignationConfirmModal').data('employee-id');
    const resignationDate = $('#resignationConfirmModal').data('resignation-date');
    if (!employeeId || !resignationDate) {
        console.error('Missing employee ID or resignation date');
        alert('No employee or resignation date selected.');
        $btn.prop('disabled', false);
        return;
    }
    proceedWithResignation(employeeId, resignationDate);
});

function proceedWithResignation(employeeId, resignationDate) {
    console.log('Resigning employee ID:', employeeId, 'with date:', resignationDate);
    $.ajax({
        url: '/resign_employee/',
        type: 'POST',
        data: {
            employee_id: employeeId,
            emp_resigning_date: resignationDate,
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                alert('Employee resigned successfully.');
                $('#assetHandoverModal').modal('hide');
                $('#viewEmployeeModal').modal('hide');
                refreshEmployeeList();
            } else {
                console.error('Resignation error:', response.error);
                alert('Error: ' + response.error);
            }
        },
        error: function(xhr) {
            console.error('Error resigning employee:', xhr.status, xhr.statusText);
            alert('Failed to process resignation.');
        }
    });
}

function loadEmployeeDetails(employeeId) {
    console.log('Loading details for employee ID:', employeeId);
    const $body = $('#employeeDetailsBody');
    $body.html('<p>Loading employee details...</p>');
    $.ajax({
        url: `/get_employee_details/?id=${employeeId}`,
        type: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function(data) {
            $body.html(data);
            $('#resignEmployeeBtn').attr('data-employee-id', employeeId);
        },
        error: function(xhr) {
            console.error('Error loading employee details:', xhr.status, xhr.statusText);
            $body.html('<p class="text-danger">Failed to load employee details.</p>');
        }
    });
}

function deleteEmployee(employeeId) {
    if (confirm('Are you sure you want to delete this employee?')) {
        console.log('Deleting employee ID:', employeeId);
        $.ajax({
            url: `/employee/delete/${employeeId}/`,
            type: 'POST',
            data: { csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val() },
            success: function(data) {
                if (data.success) {
                    refreshEmployeeList();
                } else {
                    alert('Error deleting employee: ' + data.error);
                }
            },
            error: function(xhr) {
                console.error('Error deleting employee:', xhr.status, xhr.statusText);
                alert('Failed to delete employee.');
            }
        });
    }
}

function upgradeModal(employeeId, companyId) {
    console.log('Opening upgrade modal for employee ID:', employeeId, 'with company ID:', companyId);
    $('#branchTransferForm, #salaryIncrementForm, #promotionForm').trigger('reset');
    $('#branchTransferEmployeeId, #salaryIncrementEmployeeId, #promotionEmployeeId').val(employeeId);
    $('#currentBranch, #currentSalary, #currentDepartment, #currentSubDepartment, #currentCategory, #currentDesignation').val('Loading...');

    const today = new Date().toISOString().split('T')[0];
    $('#promotionStartDate').attr('max', today).val(today);

    $('#upgradeModal').modal('show');

    if (companyId && companyId !== 0) {
        loadPromotionDepartments(companyId);
    } else {
        console.warn('No company associated with employee:', employeeId);
        $('#newDepartment').html('<option value="" disabled selected>-- No Company Assigned --</option>');
        $('#newDepartment, #newSubDepartment, #newCategory, #newDesignation').prop('disabled', true);
        alert('This employee has no associated company. Please assign a company to enable promotion options.');
    }

    $.ajax({
        url: '/get_employee_details_for_upgrade/',
        type: 'GET',
        data: { employee_id: employeeId },
        success: function(response) {
            console.log('Employee details response:', response);
            if (response.success && response.employee) {
                $('#promotionForm').data('employee_details', response.employee);
                $('#currentBranch').val(response.employee.branch_name || 'N/A');
                $('#newBranch option').each(function() {
                    const isCurrent = $(this).val() === String(response.employee.branch_id);
                    $(this).prop('disabled', isCurrent).text(
                        isCurrent ? $(this).text() + ' (Current)' : $(this).text().replace(' (Current)', '')
                    );
                });
                const salary = response.employee.emp_salary;
                $('#currentSalary').val(salary != null ? parseFloat(salary).toFixed(2) : 'N/A');
                $('#newSalary').attr('min', salary != null ? (parseFloat(salary) + 0.01).toFixed(2) : '0.01');
                $('#currentDepartment').val(response.employee.department_name || 'N/A');
                $('#currentSubDepartment').val(response.employee.sub_department_name || 'N/A');
                $('#currentCategory').val(response.employee.category_name || 'N/A');
                $('#currentDesignation').val(response.employee.designation_name || 'N/A');

                const joiningDate = response.employee.emp_joining_date;
                if (joiningDate) {
                    $('#promotionStartDate').attr('min', joiningDate);
                }

                $('#promotionForm').data('employee_details', {
                    department_id: response.employee.department_id || '',
                    sub_department_id: response.employee.sub_department_id || '',
                    category_id: response.employee.category_id || '',
                    designation_id: response.employee.designation_id || '',
                    emp_joining_date: response.employee.emp_joining_date || ''
                });
            } else {
                console.error('Failed to load employee details:', response.error || 'No employee data');
                $('#currentBranch, #currentSalary, #currentDepartment, #currentSubDepartment, #currentCategory, #currentDesignation')
                    .val('Error loading');
                $('#newDepartment').html('<option value="" disabled selected>-- Error Loading --</option>');
            }
        },
        error: function(xhr, status, error) {
            console.error('AJAX error fetching employee details:', status, error);
            $('#currentBranch, #currentSalary, #currentDepartment, #currentSubDepartment, #currentCategory, #currentDesignation')
                .val('Failed to load');
            $('#newDepartment').html('<option value="" disabled selected>-- Failed to Load --</option>');
        }
    });
}

function loadPromotionDepartments(companyId) {
    $.ajax({
        url: `/department/by-company/${companyId}/`,
        type: 'GET',
        success: function(response) {
            if (response.success && response.departments) {
                let options = '<option value="" selected>Select Department</option>';
                response.departments.forEach(dept => {
                    options += `<option value="${dept.id}">${dept.department_name}</option>`;
                });
                $('#newDepartment').html(options).prop('disabled', false);
            } else {
                $('#newDepartment').html('<option value="" disabled selected>-- No Departments Available --</option>');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading departments:', error);
            $('#newDepartment').html('<option value="" disabled selected>-- Failed to Load --</option>');
        }
    });
}

function loadPromotionSubDepartments(departmentId) {
    return fetch(`/sub-department/by-department/${departmentId}/`)
        .then(response => response.json())
        .then(data => {
            const subDeptSelect = document.getElementById('newSubDepartment');
            subDeptSelect.innerHTML = '<option value="" disabled selected>-- Select Sub-Department --</option>';
            if (data.success && Array.isArray(data.subdepartments)) {
                data.subdepartments.forEach(subDept => {
                    const option = document.createElement('option');
                    option.value = subDept.id;
                    option.textContent = subDept.sub_department_name;
                    subDeptSelect.appendChild(option);
                });
            } else {
                subDeptSelect.innerHTML = '<option value="" disabled selected>-- No Sub-Departments Available --</option>';
            }
        })
        .catch(error => {
            console.error('Error loading sub-departments:', error);
            document.getElementById('newSubDepartment').innerHTML = '<option value="" disabled selected>-- Select Sub-Department --</option>';
        });
}

function loadPromotionCategories(subDepartmentId) {
    return fetch(`/category/by-subdepartment/${subDepartmentId}/`)
        .then(response => response.json())
        .then(data => {
            const categorySelect = document.getElementById('newCategory');
            categorySelect.innerHTML = '<option value="" disabled selected>-- Select Category --</option>';
            if (data.success && Array.isArray(data.categories)) {
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.category_name;
                    categorySelect.appendChild(option);
                });
            } else {
                categorySelect.innerHTML = '<option value="" disabled selected>-- No Categories Available --</option>';
            }
        })
        .catch(error => {
            console.error('Error loading categories:', error);
            document.getElementById('newCategory').innerHTML = '<option value="" disabled selected>-- Select Category --</option>';
        });
}

function loadPromotionDesignations(categoryId) {
    return fetch(`/designation/by-category/${categoryId}/`)
        .then(response => response.json())
        .then(data => {
            const desigSelect = document.getElementById('newDesignation');
            desigSelect.innerHTML = '<option value="" disabled selected>-- Select Designation --</option>';
            if (data.success && Array.isArray(data.designations)) {
                data.designations.forEach(desig => {
                    const option = document.createElement('option');
                    option.value = desig.id;
                    option.textContent = desig.designation_name;
                    desigSelect.appendChild(option);
                });
            } else {
                desigSelect.innerHTML = '<option value="" disabled selected>-- No Designations Available --</option>';
            }
        })
        .catch(error => {
            console.error('Error loading designations:', error);
            document.getElementById('newDesignation').innerHTML = '<option value="" disabled selected>-- Select Designation --</option>';
        });
}

$(document).ready(function() {
    $('#newDepartment').on('change', function() {
        const departmentId = this.value;
        document.getElementById('newSubDepartment').innerHTML = '<option value="" disabled selected>-- Select Sub-Department --</option>';
        document.getElementById('newCategory').innerHTML = '<option value="" disabled selected>-- Select Category --</option>';
        document.getElementById('newDesignation').innerHTML = '<option value="" disabled selected>-- Select Designation --</option>';
        if (departmentId) {
            loadPromotionSubDepartments(departmentId);
        }
    });

    $('#newSubDepartment').on('change', function() {
        const subDepartmentId = this.value;
        document.getElementById('newCategory').innerHTML = '<option value="" disabled selected>-- Select Category --</option>';
        document.getElementById('newDesignation').innerHTML = '<option value="" disabled selected>-- Select Designation --</option>';
        if (subDepartmentId) {
            loadPromotionCategories(subDepartmentId);
        }
    });

    $('#newCategory').on('change', function() {
        const categoryId = this.value;
        document.getElementById('newDesignation').innerHTML = '<option value="" disabled selected>-- Select Designation --</option>';
        if (categoryId) {
            loadPromotionDesignations(categoryId);
        }
    });

    $('#employeeSearch, #skillSearch').on('input', filterEmployees);
    $('#filterGender, #filterCompany, #filterDepartment, #filterSubDepartment, #filterCategory, #filterDesignation, #filterQualification, #filterZone, #filterBranch').on('change', filterEmployees);

    filterEmployees();
});

$('#branchTransferForm').on('submit', function(e) {
    e.preventDefault();
    const $form = $(this);
    $form.find('.is-invalid').removeClass('is-invalid');
    const employeeId = $('#branchTransferEmployeeId').val();
    const branchId = $('#newBranch').val();
    const startDate = $('#startDate').val();
    if (!employeeId || !branchId || !startDate) {
        if (!employeeId) alert('Employee ID is missing.');
        if (!branchId) $('#newBranch').addClass('is-invalid');
        if (!startDate) $('#startDate').addClass('is-invalid');
        alert('Please fill in all required fields.');
        return;
    }
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const selectedDate = new Date(startDate);
    selectedDate.setHours(0, 0, 0, 0);
    if (selectedDate < today) {
        $('#startDate').addClass('is-invalid');
        alert('Transfer date cannot be in the past.');
        return;
    }
    $.ajax({
        url: '/transfer_branch/',
        type: 'POST',
        data: {
            employee_id: employeeId,
            branch_id: branchId,
            start_date: startDate,
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                alert('Branch transfer completed successfully.');
                $('#upgradeModal').modal('hide');
                refreshEmployeeList();
            } else {
                alert('Error: ' + response.error);
            }
        },
        error: function(xhr) {
            console.error('Error:', xhr.status, xhr.statusText);
            alert(`Failed to submit branch transfer: ${xhr.status} ${xhr.statusText}`);
        }
    });
});

$('#salaryIncrementForm').on('submit', function(e) {
    e.preventDefault();
    const $form = $(this);
    $form.find('.is-invalid').removeClass('is-invalid');
    const employeeId = $('#salaryIncrementEmployeeId').val();
    const newSalary = parseFloat($('#newSalary').val());
    const startDate = $('#salaryStartDate').val();
    const currentSalary = $('#currentSalary').val() === 'N/A' ? null : parseFloat($('#currentSalary').val());
    if (!employeeId || !newSalary || !startDate) {
        if (!employeeId) alert('Employee ID is missing.');
        if (!newSalary) $('#newSalary').addClass('is-invalid');
        if (!startDate) $('#salaryStartDate').addClass('is-invalid');
        alert('Please fill in all required fields.');
        return;
    }
    if (newSalary <= 0) {
        $('#newSalary').addClass('is-invalid');
        alert('Please enter a valid salary.');
        return;
    }
    if (currentSalary != null && newSalary <= currentSalary) {
        $('#newSalary').addClass('is-invalid');
        alert('New salary must be greater than the current salary.');
        return;
    }
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const selectedDate = new Date(startDate);
    selectedDate.setHours(0, 0, 0, 0);
    if (selectedDate < today) {
        $('#salaryStartDate').addClass('is-invalid');
        alert('Salary change date cannot be in the past.');
        return;
    }
    $.ajax({
        url: '/increment_salary/',
        type: 'POST',
        data: {
            employee_id: employeeId,
            salary: newSalary,
            start_date: startDate,
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                alert('Salary incremented successfully.');
                $('#upgradeModal').modal('hide');
                refreshEmployeeList();
            } else {
                alert('Error: ' + response.error);
            }
        },
        error: function(xhr) {
            console.error('Error:', xhr.status, xhr.statusText);
            alert(`Failed to submit salary increment: ${xhr.status} ${xhr.statusText}`);
        }
    });
});

$('#promotionForm').on('submit', function(e) {
    e.preventDefault();
    const $form = $(this);
    $form.find('.is-invalid').removeClass('is-invalid');

    const employeeId = $('#promotionEmployeeId').val();
    const newDesignationId = $('#newDesignation').val();
    const newDepartmentId = $('#newDepartment').val();
    const newSubDepartmentId = $('#newSubDepartment').val();
    const newCategoryId = $('#newCategory').val();
    const startDate = $('#promotionStartDate').val();

    if (!employeeId) {
        alert('Employee ID is missing.');
        return;
    }
    if (!newDesignationId) {
        $('#newDesignation').addClass('is-invalid');
        alert('Please select a designation.');
        return;
    }
    if (!newDepartmentId) {
        $('#newDepartment').addClass('is-invalid');
        alert('Please select a department.');
        return;
    }
    if (!newSubDepartmentId) {
        $('#newSubDepartment').addClass('is-invalid');
        alert('Please select a sub-department.');
        return;
    }
    if (!newCategoryId) {
        $('#newCategory').addClass('is-invalid');
        alert('Please select a category.');
        return;
    }
    if (!startDate) {
        $('#promotionStartDate').addClass('is-invalid');
        alert('Please select a promotion date.');
        return;
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const selectedDate = new Date(startDate);
    selectedDate.setHours(0, 0, 0, 0);
    const joiningDate = new Date($('#promotionForm').data('employee_details').emp_joining_date);
    joiningDate.setHours(0, 0, 0, 0);

    if (selectedDate > today) {
        $('#promotionStartDate').addClass('is-invalid');
        alert('Promotion date cannot be in the future.');
        return;
    }
    if (joiningDate && selectedDate < joiningDate) {
        $('#promotionStartDate').addClass('is-invalid');
        alert('Promotion date cannot be before the employee\'s joining date.');
        return;
    }

    const employeeDetails = $('#promotionForm').data('employee_details') || {};
    const currentDepartmentId = employeeDetails.department_id || '';
    const currentSubDepartmentId = employeeDetails.sub_department_id || '';
    const currentCategoryId = employeeDetails.category_id || '';
    const currentDesignationId = employeeDetails.designation_id || '';
    if (newDepartmentId === currentDepartmentId &&
        newSubDepartmentId === currentSubDepartmentId &&
        newCategoryId === currentCategoryId &&
        newDesignationId === currentDesignationId) {
        alert('New promotion details must differ from current details.');
        return;
    }

    $.ajax({
        url: '/promote_employee/',
        type: 'POST',
        data: {
            employee_id: employeeId,
            department_id: newDepartmentId,
            sub_department_id: newSubDepartmentId,
            category_id: newCategoryId,
            designation_id: newDesignationId,
            start_date: startDate,
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                alert('Employee promoted successfully.');
                $('#upgradeModal').modal('hide');
                refreshEmployeeList();
            } else {
                console.error('Server error:', response.error);
                alert('Error: ' + response.error);
            }
        },
        error: function(xhr) {
            console.error('AJAX error:', xhr.status, xhr.statusText, xhr.responseText);
            let errorMsg = 'Failed to submit promotion';
            try {
                const response = JSON.parse(xhr.responseText);
                errorMsg += `: ${response.error || 'Unknown error'}`;
            } catch (e) {
                errorMsg += `: ${xhr.status} ${xhr.statusText}`;
            }
            alert(errorMsg);
        }
    });
});

function filterEmployees() {
    console.log('Filtering employees...');
    const nameSearch = ($('#employeeSearch').val() || '').toLowerCase().trim();
    const skillSearch = ($('#skillSearch').val() || '').toLowerCase().trim();
    const genderFilter = $('#filterGender').val();
    const companyFilter = $('#filterCompany').val();
    const departmentFilter = $('#filterDepartment').val();
    const subDepartmentFilter = $('#filterSubDepartment').val();
    const categoryFilter = $('#filterCategory').val();
    const designationFilter = $('#filterDesignation').val();
    const qualificationFilter = $('#filterQualification').val();
    const zoneFilter = $('#filterZone').val();
    const branchFilter = $('#filterBranch').val();

    $('#employeeTableBody tr:not(#noMatchesRow)').each(function() {
        const $row = $(this);
        // Safely retrieve data attributes, defaulting to empty string or '0' for IDs
        const name = ($row.data('employee-name') || '').toLowerCase();
        const skills = ($row.data('skills') || '').toLowerCase();
        const gender = String($row.data('gender') || '');
        const companyId = String($row.data('company-id') || '0');
        const departmentId = String($row.data('department-id') || '0');
        const subDepartmentId = String($row.data('sub-department-id') || '0');
        const categoryId = String($row.data('category-id') || '0');
        const designationId = String($row.data('designation-id') || '0');
        const qualificationId = String($row.data('qualification-id') || '0');
        const zoneId = String($row.data('zone-id') || '0');
        const branchId = String($row.data('branch-id') || '0');

        let matches = true;

        if (nameSearch && !name.includes(nameSearch)) {
            matches = false;
            console.log(`Row ${$row.data('employee-id')} does not match name: ${nameSearch}`);
        }
        if (skillSearch) {
            const skillsArray = skills.split(',').map(s => s.trim());
            const skillMatch = skillsArray.some(skill => skill.includes(skillSearch));
            if (!skillMatch) {
                matches = false;
                console.log(`Row ${$row.data('employee-id')} does not match skill: ${skillSearch}`);
            }
        }
        if (genderFilter && gender !== genderFilter) {
            matches = false;
            console.log(`Row ${$row.data('employee-id')} does not match gender: ${genderFilter}`);
        }
        if (companyFilter && companyId !== companyFilter) {
            matches = false;
            console.log(`Row ${$row.data('employee-id')} does not match company: ${companyFilter}`);
        }
        if (departmentFilter && departmentId !== departmentFilter) {
            matches = false;
            console.log(`Row ${$row.data('employee-id')} does not match department: ${departmentFilter}`);
        }
        if (subDepartmentFilter && subDepartmentId !== subDepartmentFilter) {
            matches = false;
            console.log(`Row ${$row.data('employee-id')} does not match sub-department: ${subDepartmentFilter}`);
        }
        if (categoryFilter && categoryId !== categoryFilter) {
            matches = false;
            console.log(`Row ${$row.data('employee-id')} does not match category: ${categoryFilter}`);
        }
        if (designationFilter && designationId !== designationFilter) {
            matches = false;
            console.log(`Row ${$row.data('employee-id')} does not match designation: ${designationFilter}`);
        }
        if (qualificationFilter && qualificationId !== qualificationFilter) {
            matches = false;
            console.log(`Row ${$row.data('employee-id')} does not match qualification: ${qualificationFilter}`);
        }
        if (zoneFilter && zoneId !== zoneFilter) {
            matches = false;
            console.log(`Row ${$row.data('employee-id')} does not match zone: ${zoneFilter}`);
        }
        if (branchFilter && branchId !== branchFilter) {
            matches = false;
            console.log(`Row ${$row.data('employee-id')} does not match branch: ${branchFilter}`);
        }

        $row.data('matches', matches);
        console.log(`Row ${$row.data('employee-id')} matches: ${matches}`);
    });

    currentPage = 1;
    updatePagination();
}

function sortEmployees(field, order) {
    console.log(`Sorting by ${field}, order: ${order}`);
    currentSortField = field;
    currentSortOrder = order;
    currentPage = 1;
    updatePagination();
}

function updatePagination() {
    console.log('Updating pagination...');
    const $allRows = $('#employeeTableBody tr:not(#noMatchesRow)');
    const $filteredRows = $allRows.filter(function() {
        const matches = $(this).data('matches') === true || $(this).data('matches') === 'true';
        console.log(`Row ${$(this).data('employee-id')} filter match: ${matches}`);
        return matches;
    });

    $allRows.hide();

    let rowsToDisplay = $filteredRows.toArray();

    if (currentSortField && currentSortOrder) {
        const sortKeyMap = {
            'name': 'employee-name',
            'joining_date': 'joining-date',
            'designation': 'designation-rank'
        };
        const sortKey = sortKeyMap[currentSortField];

        rowsToDisplay = rowsToDisplay.sort(function(a, b) {
            if (currentSortField === 'joining_date') {
                const aDate = new Date($(a).data('joining-date') || '1900-01-01');
                const bDate = new Date($(b).data('joining-date') || '1900-01-01');
                return currentSortOrder === 'asc' ? aDate - bDate : bDate - aDate;
            } else if (currentSortField === 'designation') {
                const aRank = parseInt($(a).data('designation-rank') || 999999, 10);
                const bRank = parseInt($(b).data('designation-rank') || 999999, 10);
                return currentSortOrder === 'asc' ? aRank - bRank : bRank - aRank;
            } else {
                const aValue = String($(a).data(sortKey) || '').toLowerCase();
                const bValue = String($(b).data(sortKey) || '').toLowerCase();
                if (aValue === bValue) return 0;
                return currentSortOrder === 'asc' ? (aValue < bValue ? -1 : 1) : (aValue > bValue ? -1 : 1);
            }
        });
    }

    if (rowsToDisplay.length === 0) {
        $('#noMatchesRow').show();
        $('#paginationControls').hide();
        console.log('No matching rows found.');
    } else {
        $('#noMatchesRow').hide();
        const start = (currentPage - 1) * recordsPerPage;
        const end = start + recordsPerPage;
        const pageRows = rowsToDisplay.slice(start, end);

        $(pageRows).show().each(function(index) {
            $(this).find('.serial-number').text(start + index + 1);
        });

        const totalRecords = rowsToDisplay.length;
        const totalPages = Math.ceil(totalRecords / recordsPerPage);
        let paginationHtml = '';
        if (totalPages > 1) {
            paginationHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Previous</a></li>`;
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a></li>`;
            }
            paginationHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Next</a></li>`;
        }
        $('#paginationControls').html(paginationHtml).show();
        console.log(`Displaying ${pageRows.length} rows of ${totalRecords} total, page ${currentPage}/${totalPages}`);
    }
}

function changePage(page) {
    console.log(`Changing to page ${page}`);
    currentPage = page;
    updatePagination();
}

function refreshEmployeeList() {
    console.log('Refreshing employee list...');
    $.ajax({
        url: '/list_employees/',
        type: 'GET',
        success: function(data) {
            $('#employeeListBox').replaceWith($(data).find('#employeeListBox'));
            filterEmployees();
        },
        error: function(xhr) {
            console.error('Error refreshing employee list:', xhr.status, xhr.statusText);
            alert('Failed to refresh employee list.');
        }
    });
}
</script>