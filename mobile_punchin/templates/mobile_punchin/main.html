<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #f3f4f6;
            font-family: Arial, sans-serif;
            padding: 1rem;
        }
        #timer {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: #1f2937;
        }
        .button {
            padding: 0.75rem 1.5rem;
            font-size: 1.25rem;
            border-radius: 0.375rem;
            margin: 0.5rem;
            width: 100%;
            max-width: 300px;
            text-align: center;
            cursor: pointer;
        }
        @media (max-width: 640px) {
            #timer {
                font-size: 2rem;
            }
            .button {
                font-size: 1rem;
                padding: 0.5rem 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container mx-auto text-center">
        <h1 class="text-3xl font-bold mb-4 text-gray-800">Time Tracker</h1>
        <p class="text-gray-600">Welcome, {{ user.username }} (ID: {{ user.id }})</p>
        <p class="text-gray-600">Email: {{ user.email }}</p>
        <p class="text-gray-600">Name: {{ user.name }}</p>
        <div id="timer">00:00:00</div>
        <div class="flex flex-col sm:flex-row justify-center">
            <button id="punchIn" class="button bg-green-500 text-white hover:bg-green-600" {% if is_punched_in %}disabled{% endif %}>Punch In</button>
            <button id="punchOut" class="button bg-red-500 text-white hover:bg-red-600" {% if not is_punched_in %}disabled{% endif %}>Punch Out</button>
        </div>
        <div id="status" class="mt-4 text-lg text-gray-600">
            {% if is_punched_in %}
                Punched in at: {{ punch_record.punch_in_time|date:"H:i:s" }}
            {% elif punch_record and punch_record.punch_out_time %}
                Last punched out at: {{ punch_record.punch_out_time|date:"H:i:s" }}
            {% endif %}
        </div>
        <a href="/logout/" class="text-blue-500 hover:underline mt-4 inline-block">Log Out</a>
    </div>

    <script>
        let startTime = {% if is_punched_in %}new Date('{{ punch_record.punch_in_time.isoformat }}').getTime(){% else %}null{% endif %};
        let timerInterval = null;

        const timerDisplay = document.getElementById('timer');
        const punchInButton = document.getElementById('punchIn');
        const punchOutButton = document.getElementById('punchOut');
        const statusDisplay = document.getElementById('status');

        function updateTimer() {
            const now = new Date().getTime();
            const elapsed = now - startTime;
            const hours = Math.floor(elapsed / 3600000).toString().padStart(2, '0');
            const minutes = Math.floor((elapsed % 3600000) / 60000).toString().padStart(2, '0');
            const seconds = Math.floor((elapsed % 60000) / 1000).toString().padStart(2, '0');
            timerDisplay.textContent = `${hours}:${minutes}:${seconds}`;
        }

        if (startTime) {
            timerInterval = setInterval(updateTimer, 1000);
        }

        punchInButton.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/punch-in/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                const data = await response.json();
                if (response.ok) {
                    startTime = new Date(data.punch_in_time).getTime();
                    timerInterval = setInterval(updateTimer, 1000);
                    punchInButton.disabled = true;
                    punchOutButton.disabled = false;
                    statusDisplay.textContent = 'Punched in at: ' + new Date(startTime).toLocaleTimeString();
                } else {
                    statusDisplay.textContent = data.error || 'Punch-in failed';
                }
            } catch (error) {
                statusDisplay.textContent = 'An error occurred. Please try again.';
            }
        });

        punchOutButton.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/punch-out/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                const data = await response.json();
                if (response.ok) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = '00:00:00';
                    punchInButton.disabled = false;
                    punchOutButton.disabled = true;
                    statusDisplay.textContent = 'Punched out at: ' + new Date(data.punch_out_time).toLocaleTimeString();
                    startTime = null;
                } else {
                    statusDisplay.textContent = data.error || 'Punch-out failed';
                }
            } catch (error) {
                statusDisplay.textContent = 'An error occurred. Please try again.';
            }
        });
    </script>
</body>
</html>